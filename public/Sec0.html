<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AION Fleet Intelligence — iONE Telemetry & Predictive Training</title>

  <!-- Optional fonts (will gracefully fall back to monospace if blocked) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=Fira+Code:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#1a1a2e;
      --panel:#141427;
      --panel2:#101022;
      --stroke:#2a2a45;

      --accent:#0ABFBC;
      --accent2:#00D9FF;
      --warn:#FFB800;
      --err:#FF4444;

      --text:#ffffff;
      --muted:#888888;

      --mono: "JetBrains Mono","Fira Code",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --shadow: 0 24px 60px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--mono);
      overflow:hidden;
    }

    /* ====== FRAME 1920×1080-ish (responsive) ====== */
    .frame{
      height:100%;
      display:grid;
      grid-template-rows: 74px 1fr 64px;
      grid-template-columns: 60% 40%;
      grid-template-areas:
        "header header"
        "left   right"
        "footer footer";
    }

    /* ====== HEADER ====== */
    header{
      grid-area:header;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 26px;
      border-bottom:1px solid var(--stroke);
      background:rgba(16,16,34,.55);
      backdrop-filter: blur(6px);
    }
    .h-title{
      font-weight:800;
      letter-spacing:.9px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .h-dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--accent2);
      box-shadow: 0 0 0 6px rgba(0,217,255,.12), 0 0 22px rgba(0,217,255,.25);
    }
    .h-sub{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.3px;
      margin-top:4px;
    }
    .h-right{
      display:flex;
      align-items:center;
      gap:14px;
      color:var(--muted);
      font-size:12px;
    }
    .pill{
      border:1px solid var(--stroke);
      padding:10px 12px;
      border-radius:999px;
      background:rgba(20,20,39,.7);
      box-shadow: 0 10px 28px rgba(0,0,0,.2);
      color:rgba(255,255,255,.85);
    }
    .pill b{color:var(--accent2); font-weight:800}

    /* ====== LEFT (MAP) ====== */
    .left{
      grid-area:left;
      padding:18px 18px 14px 18px;
      border-right:1px solid var(--stroke);
      position:relative;
      overflow:hidden;
    }
    .mapCard{
      height:100%;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(16,16,34,.55), rgba(10,10,22,.35));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .mapTop{
      position:absolute;
      left:16px; right:16px; top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:5;
      pointer-events:none;
    }
    .mapLabel{
      pointer-events:none;
      font-size:12px;
      color:rgba(255,255,255,.85);
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .mapLabel .tag{
      padding:7px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(20,20,39,.65);
      color:rgba(255,255,255,.85);
    }
    .legend{
      pointer-events:none;
      display:flex;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:11px;
    }
    .lg{
      display:flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(20,20,39,.65);
    }
    .sw{width:10px;height:10px;border-radius:50%}
    .sw.nom{background:var(--accent)}
    .sw.warn{background:var(--warn)}
    .sw.err{background:var(--err)}
    .sw.off{background:#5a5a79}

    /* World canvas */
    .mapWrap{
      position:absolute;
      inset:0;
      padding:58px 0 0 0;
    }
    canvas#mapCanvas{
      width:100%;
      height:100%;
      display:block;
    }

    /* AION ingress node - positioned in GERMANY (new projection) */
    /* For bounds lat -5 to 75, lng -25 to 70: Germany (51°N, 10°E) =
       x: (10-(-25))/(70-(-25)) = 35/95 ≈ 37%
       y: (75-51)/(75-(-5)) = 24/80 = 30% */
    .ingress{
      position:absolute;
      left:40%;
      top:32%;
      transform:translate(-50%,-50%);
      width:86px;height:86px;
      border-radius:50%;
      border:1px solid rgba(0,217,255,.35);
      background:radial-gradient(circle at 50% 50%, rgba(0,217,255,.18), rgba(10,191,188,.08), rgba(0,0,0,0));
      box-shadow: 0 0 0 10px rgba(0,217,255,.06), 0 0 32px rgba(0,217,255,.18);
      z-index:4;
      pointer-events:none;
      opacity:0;
    }
    .ingress::before{
      content:"";
      position:absolute; inset:10px;
      border-radius:50%;
      border:1px dashed rgba(10,191,188,.35);
      opacity:.85;
      animation: spin 6s linear infinite;
    }
    .ingress::after{
      content:"AION";
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      font-weight:800;
      letter-spacing:.8px;
      color:rgba(255,255,255,.92);
      font-size:12px;
    }

    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Station pulse (canvas drawn, but we also animate global glow) */
    .mapGlow{
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 420px at 18% 45%, rgba(0,217,255,.10), rgba(0,0,0,0) 60%),
        radial-gradient(700px 380px at 70% 60%, rgba(10,191,188,.08), rgba(0,0,0,0) 60%);
      opacity:.0;
      transition: opacity .8s ease;
      z-index:1;
      pointer-events:none;
    }

    /* ====== RIGHT ====== */
    .right{
      grid-area:right;
      padding:18px 18px 14px 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius:18px;
      background:rgba(16,16,34,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
      opacity:0;
      transform: translateY(8px);
      transition: opacity .6s ease, transform .6s ease;
    }
    .panel.on{
      opacity:1;
      transform: translateY(0);
    }
    .p-head{
      padding:14px 16px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .p-head h3{
      margin:0;
      font-size:12px;
      letter-spacing:.6px;
      color:rgba(255,255,255,.92);
      font-weight:800;
    }
    .p-head .hint{
      color:var(--muted);
      font-size:11px;
    }
    .p-body{
      padding:14px 16px 16px;
    }

    /* AION engine visuals */
    .engineTop{
      display:grid;
      grid-template-columns: 98px 1fr;
      gap:14px;
      align-items:center;
      margin-bottom:14px;
    }
    .core{
      width:98px;height:98px;border-radius:22px;
      border:1px solid rgba(0,217,255,.25);
      background:
        radial-gradient(circle at 35% 30%, rgba(0,217,255,.22), rgba(10,191,188,.10) 45%, rgba(0,0,0,0) 75%),
        linear-gradient(180deg, rgba(20,20,39,.75), rgba(12,12,26,.55));
      position:relative;
      box-shadow: 0 0 0 10px rgba(0,217,255,.05), 0 0 42px rgba(0,217,255,.14);
    }
    .core .ring{
      position:absolute;
      inset:-10px;
      border-radius:28px;
      border:1px solid rgba(10,191,188,.18);
      box-shadow: 0 0 28px rgba(10,191,188,.12);
      animation: ringPulse 2.2s ease-in-out infinite;
    }
    @keyframes ringPulse{
      0%{ transform: scale(1); opacity:.55; }
      50%{ transform: scale(1.06); opacity:.20; }
      100%{ transform: scale(1); opacity:.55; }
    }
    .core .label{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      font-weight:800;
      letter-spacing:1px;
      color:rgba(255,255,255,.92);
    }
    .engineMeta{
      color:rgba(255,255,255,.90);
      font-size:12px;
      line-height:1.55;
    }
    .engineMeta .mut{color:var(--muted)}
    .bar{
      margin-top:10px;
      border:1px solid var(--stroke);
      background:rgba(10,10,22,.55);
      border-radius:12px;
      padding:10px 10px;
      position:relative;
      overflow:hidden;
    }
    .bar .fill{
      height:10px;
      border-radius:10px;
      width:20%;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 0 22px rgba(0,217,255,.25);
      transition: width .6s ease;
    }
    .bar .txt{
      display:flex;
      justify-content:space-between;
      margin-top:8px;
      font-size:11px;
      color:rgba(255,255,255,.88);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      margin-top:14px;
      font-size:12px;
      line-height:1.55;
    }
    .kv{
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(10,10,22,.45);
    }
    .kv .k{color:var(--muted); font-size:11px}
    .kv .v{color:rgba(255,255,255,.92); font-weight:700; margin-top:4px}
    .kv .v b{color:var(--accent2)}

    /* Telemetry feed */
    .telemetry{
      height: 340px;
      overflow:hidden;
      position:relative;
    }
    .telemetryList{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .tItem{
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(10,10,22,.45);
      padding:10px 10px;
      opacity:0;
      transform: translateY(-6px);
      animation: appear .35s ease forwards;
    }
    @keyframes appear{
      to{ opacity:1; transform: translateY(0); }
    }
    .tTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
      font-size:12px;
      color:rgba(255,255,255,.92);
      font-weight:700;
    }
    .tTop .loc{
      color:var(--muted);
      font-weight:400;
      margin-left:8px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--stroke);
      background:rgba(20,20,39,.6);
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.88);
    }
    .bDot{width:9px;height:9px;border-radius:50%}
    .bNom{background:var(--accent)}
    .bWarn{background:var(--warn)}
    .bErr{background:var(--err)}
    .tLine{
      display:flex;
      justify-content:space-between;
      font-size:11.5px;
      padding:2px 0;
      color:rgba(255,255,255,.86);
    }
    .tLine .k{color:var(--muted)}
    .sigma{
      color:var(--warn);
      font-weight:800;
      margin-left:8px;
    }
    .okMark{color:rgba(10,191,188,.95); font-weight:800}
    .warnMark{color:var(--warn); font-weight:800}
    .errMark{color:var(--err); font-weight:800}

    /* Anomaly block (right panel) */
    .anomalySlot{
      min-height: 220px;
      position:relative;
    }
    .anomalyEmpty{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:14px 12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      background:rgba(10,10,22,.35);
    }

    /* Anomaly popup overlay */
    .popup{
      position:fixed;
      right:34px;
      top:128px;
      width: 520px;
      border-radius:18px;
      border:1px solid rgba(255,184,0,.35);
      background:rgba(20,20,39,.90);
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      overflow:hidden;
      z-index:50;
      opacity:0;
      transform: translateY(-10px);
      pointer-events:none;
      transition: opacity .35s ease, transform .35s ease;
    }
    .popup.on{
      opacity:1;
      transform: translateY(0);
    }
    .popupHead{
      padding:14px 16px 12px;
      border-bottom:1px solid rgba(255,184,0,.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:rgba(255,255,255,.92);
      font-weight:900;
      letter-spacing:.4px;
      font-size:12px;
    }
    .popupHead .tri{
      color:var(--warn);
      margin-right:10px;
      font-size:14px;
    }
    .popupBody{
      padding:14px 16px 16px;
      font-size:12px;
      line-height:1.6;
      color:rgba(255,255,255,.90);
    }
    .popupBody .row{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 12px;
      margin-bottom:12px;
    }
    .popupBody .row .k{color:var(--muted)}
    .popupBody .row .v{font-weight:800}
    .miniChart{
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background:rgba(10,10,22,.55);
      padding:12px;
    }
    .miniChart canvas{width:100%; height:120px; display:block;}
    .popupFoot{
      margin-top:12px;
      color:rgba(255,255,255,.90);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .popupFoot .pred{
      color:rgba(255,255,255,.92);
      font-weight:900;
    }
    .popupFoot .mut{color:var(--muted)}
    .popupFoot .link{
      color:var(--accent2);
      font-weight:900;
    }

    /* ====== FOOTER ====== */
    footer{
      grid-area:footer;
      border-top:1px solid var(--stroke);
      background:rgba(16,16,34,.55);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      padding:0 26px;
      gap:14px;
      overflow:hidden;
    }
    .footerLine{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      letter-spacing:.2px;
      color:rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .footerLine b{color:var(--accent2)}
    .sep{
      color:rgba(255,255,255,.15);
      padding:0 10px;
    }

    /* ====== REVEAL TIMING ====== */
    .reveal-0 header{opacity:1}
    .mapCard{opacity:0; transform: translateY(10px); transition: opacity .7s ease, transform .7s ease;}
    .mapCard.on{opacity:1; transform: translateY(0);}
    .ingress.on{opacity:1; transition: opacity .8s ease .2s;}
    .mapGlow.on{opacity:1;}

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }
  </style>
</head>

<body>
  <div class="frame reveal-0" id="root">

    <header>
      <div>
        <div class="h-title">
          <span class="h-dot"></span>
          <span>AION FLEET INTELLIGENCE</span>
        </div>
        <div class="h-sub">Cloud AI · Corridor-of-Normal (μ ± 2σ) · 7+ day failure prediction</div>
      </div>

      <div class="h-right">
        <div class="pill">Edge: <b>iONEOS</b> (offline)</div>
        <div class="pill">Cloud: <b>AION</b> (training)</div>
        <div class="pill" id="clock">--:--:--</div>
      </div>
    </header>

    <section class="left">
      <div class="mapCard" id="mapCard">
        <div class="mapTop">
          <div class="mapLabel">
            <span class="tag">WORLD FLEET MAP · 50 iONE UNITS</span>
            <span class="tag" id="mapHint">initializing…</span>
          </div>
          <div class="legend">
            <div class="lg"><span class="sw nom"></span> nominal</div>
            <div class="lg"><span class="sw warn"></span> warning</div>
            <div class="lg"><span class="sw err"></span> anomaly</div>
            <div class="lg"><span class="sw off"></span> offline</div>
          </div>
        </div>

        <div class="mapGlow" id="mapGlow"></div>

        <div class="mapWrap">
          <canvas id="mapCanvas" width="1280" height="760"></canvas>
        </div>

        <div class="ingress" id="ingress"></div>
      </div>
    </section>

    <aside class="right">
      <!-- BLOCK 1: AION ENGINE -->
      <div class="panel" id="panelEngine">
        <div class="p-head">
          <h3>AION ENGINE</h3>
          <div class="hint" id="engineHint">central model trainer</div>
        </div>
        <div class="p-body">
          <div class="engineTop">
            <div class="core">
              <div class="ring"></div>
              <div class="label">◉ AION</div>
            </div>
            <div class="engineMeta">
              <div><span class="mut">Mode:</span> Fleet Intelligence</div>
              <div><span class="mut">Learning:</span> Corridors (μ ± 2σ) per parameter</div>
              <div><span class="mut">Prediction horizon:</span> <span style="color:var(--accent2);font-weight:900;">7+ days</span></div>

              <div class="bar">
                <div class="fill" id="trainFill"></div>
                <div class="txt">
                  <div>Model Training</div>
                  <div><span id="trainPct">0</span>%</div>
                </div>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="kv">
              <div class="k">Stations Online</div>
              <div class="v"><b id="online">47</b> / 50</div>
            </div>
            <div class="kv">
              <div class="k">Data Points / Hour</div>
              <div class="v"><b id="dph">2,847,291</b></div>
            </div>
            <div class="kv">
              <div class="k">Patterns Learned</div>
              <div class="v"><b id="patterns">12,847</b></div>
            </div>
            <div class="kv">
              <div class="k">Anomalies Today</div>
              <div class="v"><b id="anomToday">3</b></div>
            </div>
            <div class="kv" style="grid-column:1 / span 2;">
              <div class="k">Last Model Update</div>
              <div class="v"><b id="lastUpdate">2 min ago</b></div>
            </div>
          </div>
        </div>
      </div>

      <!-- BLOCK 2: LIVE TELEMETRY -->
      <div class="panel" id="panelTelemetry">
        <div class="p-head">
          <h3>LIVE TELEMETRY</h3>
          <div class="hint" id="teleHint">streaming fleet snapshots</div>
        </div>
        <div class="p-body">
          <div class="telemetry">
            <div class="telemetryList" id="telemetryList"></div>
          </div>
        </div>
      </div>

      <!-- BLOCK 3: ANOMALY DETECTED SLOT -->
      <div class="panel" id="panelAnomaly">
        <div class="p-head">
          <h3>ANOMALY DETECTED</h3>
          <div class="hint" id="anomHint">triggered by μ ± 2σ</div>
        </div>
        <div class="p-body">
          <div class="anomalySlot" id="anomalySlot">
            <div class="anomalyEmpty" id="anomalyEmpty">
              No active anomalies. Monitoring continues.<br><br>
              When a parameter crosses the corridor, AION will raise a warning,
              predict the failure window, and push updated thresholds to iONEOS.
            </div>
          </div>
        </div>
      </div>
    </aside>

    <footer>
      <div class="footerLine" id="footerLine">
        <span>FLEET: <b>50</b> units</span>
        <span class="sep">│</span>
        <span>ONLINE: <b id="fOnline">47</b></span>
        <span class="sep">│</span>
        <span>DATA TODAY: <b id="dataToday">68.3M</b> points</span>
        <span class="sep">│</span>
        <span>PREDICTIONS ACTIVE: <b id="predActive">12</b></span>
        <span class="sep">│</span>
        <span>MTBF IMPROVEMENT: <b id="mtbf">+340%</b> vs baseline</span>
      </div>
    </footer>

    <!-- ANOMALY POPUP -->
    <div class="popup" id="popup">
      <div class="popupHead">
        <div><span class="tri">⚠</span>ANOMALY DETECTED</div>
        <div style="color:rgba(255,255,255,.55);font-weight:700;" id="popupTs">—</div>
      </div>
      <div class="popupBody">
        <div class="row">
          <div class="k">Station</div><div class="v" id="pStation">—</div>
          <div class="k">Parameter</div><div class="v" id="pParam">—</div>
          <div class="k">Value</div><div class="v" id="pValue">—</div>
          <div class="k">Baseline</div><div class="v" id="pBase">—</div>
          <div class="k">Deviation</div><div class="v" id="pDev">—</div>
        </div>

        <div class="miniChart">
          <canvas id="chart" width="480" height="120"></canvas>
        </div>

        <div class="popupFoot">
          <div class="pred" id="pPred">PREDICTION: —</div>
          <div class="mut" id="pRec">—</div>
          <div class="link">→ iONEOS updated with new threshold</div>
        </div>
      </div>
    </div>

  </div>

  <script>
  (() => {
    /* ================================
       DATA: stations & telemetry params
    ================================= */
    const stations = [
      // Germany (HQ region)
      { id: "iONE-001", lat: 52.52, lng: 13.40, location: "Berlin, DE", status: "nominal" },
      { id: "iONE-002", lat: 48.14, lng: 11.58, location: "Munich, DE", status: "nominal" },
      { id: "iONE-003", lat: 50.11, lng: 8.68, location: "Frankfurt, DE", status: "nominal" },
      { id: "iONE-004", lat: 53.55, lng: 9.99, location: "Hamburg, DE", status: "nominal" },

      // Western Europe
      { id: "iONE-005", lat: 48.85, lng: 2.35, location: "Paris, FR", status: "nominal" },
      { id: "iONE-006", lat: 51.51, lng: -0.13, location: "London, UK", status: "nominal" },
      { id: "iONE-007", lat: 52.37, lng: 4.90, location: "Amsterdam, NL", status: "nominal" },
      { id: "iONE-008", lat: 50.85, lng: 4.35, location: "Brussels, BE", status: "nominal" },
      { id: "iONE-009", lat: 40.42, lng: -3.70, location: "Madrid, ES", status: "nominal" },
      { id: "iONE-010", lat: 41.90, lng: 12.50, location: "Rome, IT", status: "nominal" },

      // Nordic / Arctic
      { id: "iONE-011", lat: 78.22, lng: 15.63, location: "Svalbard, NO", status: "nominal" },
      { id: "iONE-012", lat: 71.17, lng: 25.78, location: "Vardø, NO", status: "nominal" },
      { id: "iONE-013", lat: 69.65, lng: 18.96, location: "Tromsø, NO", status: "nominal" },
      { id: "iONE-014", lat: 64.13, lng: -21.90, location: "Reykjavik, IS", status: "nominal" },
      { id: "iONE-015", lat: 63.43, lng: 10.39, location: "Trondheim, NO", status: "nominal" },
      { id: "iONE-016", lat: 59.91, lng: 10.75, location: "Oslo, NO", status: "nominal" },
      { id: "iONE-017", lat: 59.33, lng: 18.07, location: "Stockholm, SE", status: "nominal" },
      { id: "iONE-018", lat: 60.17, lng: 24.94, location: "Helsinki, FI", status: "nominal" },
      { id: "iONE-019", lat: 66.50, lng: 25.73, location: "Rovaniemi, FI", status: "nominal" },
      { id: "iONE-020", lat: 55.68, lng: 12.57, location: "Copenhagen, DK", status: "nominal" },

      // Central/Eastern Europe
      { id: "iONE-021", lat: 52.23, lng: 21.01, location: "Warsaw, PL", status: "nominal" },
      { id: "iONE-022", lat: 50.08, lng: 14.44, location: "Prague, CZ", status: "nominal" },
      { id: "iONE-023", lat: 48.21, lng: 16.37, location: "Vienna, AT", status: "nominal" },
      { id: "iONE-024", lat: 47.50, lng: 19.04, location: "Budapest, HU", status: "nominal" },

      // Balkans
      { id: "iONE-025", lat: 44.43, lng: 26.10, location: "Bucharest, RO", status: "nominal" },
      { id: "iONE-026", lat: 42.70, lng: 23.32, location: "Sofia, BG", status: "nominal" },
      { id: "iONE-027", lat: 44.82, lng: 20.46, location: "Belgrade, RS", status: "nominal" },
      { id: "iONE-028", lat: 37.98, lng: 23.73, location: "Athens, GR", status: "nominal" },

      // Turkey
      { id: "iONE-029", lat: 41.01, lng: 28.98, location: "Istanbul, TR", status: "nominal" },
      { id: "iONE-030", lat: 39.93, lng: 32.86, location: "Ankara, TR", status: "nominal" },

      // MENA - Gulf
      { id: "iONE-031", lat: 25.28, lng: 55.30, location: "Dubai, UAE", status: "nominal" },
      { id: "iONE-032", lat: 24.47, lng: 54.37, location: "Abu Dhabi, UAE", status: "nominal" },
      { id: "iONE-033", lat: 24.71, lng: 46.68, location: "Riyadh, SA", status: "warning" },
      { id: "iONE-034", lat: 28.38, lng: 36.58, location: "NEOM, SA", status: "nominal" },
      { id: "iONE-035", lat: 25.29, lng: 51.53, location: "Doha, QA", status: "nominal" },
      { id: "iONE-036", lat: 26.22, lng: 50.59, location: "Manama, BH", status: "nominal" },
      { id: "iONE-037", lat: 29.38, lng: 47.99, location: "Kuwait City, KW", status: "nominal" },
      { id: "iONE-038", lat: 23.61, lng: 58.59, location: "Muscat, OM", status: "nominal" },

      // MENA - Levant & Egypt
      { id: "iONE-039", lat: 33.89, lng: 35.50, location: "Beirut, LB", status: "nominal" },
      { id: "iONE-040", lat: 31.95, lng: 35.93, location: "Amman, JO", status: "nominal" },
      { id: "iONE-041", lat: 30.04, lng: 31.24, location: "Cairo, EG", status: "nominal" },

      // North Africa
      { id: "iONE-042", lat: 33.59, lng: -7.62, location: "Casablanca, MA", status: "nominal" },
      { id: "iONE-043", lat: 36.75, lng: 3.06, location: "Algiers, DZ", status: "nominal" },
      { id: "iONE-044", lat: 36.81, lng: 10.18, location: "Tunis, TN", status: "nominal" },
      { id: "iONE-045", lat: 32.90, lng: 13.19, location: "Tripoli, LY", status: "nominal" },

      // Offshore / Industrial
      { id: "iONE-046", lat: 62.03, lng: 6.77, location: "North Sea Platform", status: "warning" },
      { id: "iONE-047", lat: 57.05, lng: 1.50, location: "Brent Field, UK", status: "nominal" },
      { id: "iONE-048", lat: 56.00, lng: 3.50, location: "Ekofisk, NO", status: "nominal" },

      // Baltics & Eastern
      { id: "iONE-049", lat: 59.44, lng: 24.75, location: "Tallinn, EE", status: "nominal" },
      { id: "iONE-050", lat: 56.95, lng: 24.11, location: "Riga, LV", status: "nominal" },
    ];

    const telemetryParams = [
      { name: "vibration", unit: "g", normalRange: [0.2, 0.4] },
      { name: "bearing_freq", unit: "Hz", normalRange: [820, 860] },
      { name: "cell_temp", unit: "°C", normalRange: [-20, 45] },
      { name: "voltage_delta", unit: "mV", normalRange: [0, 15] },
      { name: "current", unit: "A", normalRange: [0, 25] },
      { name: "wind", unit: "km/h", normalRange: [0, 80] },
      { name: "solar", unit: "W", normalRange: [0, 4300] },
      { name: "tilt_angle", unit: "°", normalRange: [0, 90] },
      { name: "humidity", unit: "%", normalRange: [10, 90] },
    ];

    /* =================================
       UI refs
    ================================== */
    const root = document.getElementById("root");

    const mapCard = document.getElementById("mapCard");
    const mapGlow = document.getElementById("mapGlow");
    const ingress = document.getElementById("ingress");
    const mapHint = document.getElementById("mapHint");

    const panelEngine = document.getElementById("panelEngine");
    const panelTelemetry = document.getElementById("panelTelemetry");
    const panelAnomaly = document.getElementById("panelAnomaly");

    const trainFill = document.getElementById("trainFill");
    const trainPct = document.getElementById("trainPct");
    const onlineEl = document.getElementById("online");
    const dphEl = document.getElementById("dph");
    const patternsEl = document.getElementById("patterns");
    const anomTodayEl = document.getElementById("anomToday");
    const lastUpdateEl = document.getElementById("lastUpdate");

    const telemetryList = document.getElementById("telemetryList");

    const popup = document.getElementById("popup");
    const popupTs = document.getElementById("popupTs");
    const pStation = document.getElementById("pStation");
    const pParam = document.getElementById("pParam");
    const pValue = document.getElementById("pValue");
    const pBase = document.getElementById("pBase");
    const pDev = document.getElementById("pDev");
    const pPred = document.getElementById("pPred");
    const pRec = document.getElementById("pRec");

    const chartCanvas = document.getElementById("chart");
    const chartCtx = chartCanvas.getContext("2d");

    const fOnline = document.getElementById("fOnline");
    const dataToday = document.getElementById("dataToday");
    const predActive = document.getElementById("predActive");
    const mtbf = document.getElementById("mtbf");

    const clockEl = document.getElementById("clock");

    /* =================================
       Colors
    ================================== */
    const CSS = getComputedStyle(document.documentElement);
    const C = {
      bg: CSS.getPropertyValue("--bg").trim(),
      accent: CSS.getPropertyValue("--accent").trim(),
      accent2: CSS.getPropertyValue("--accent2").trim(),
      warn: CSS.getPropertyValue("--warn").trim(),
      err: CSS.getPropertyValue("--err").trim(),
      muted: CSS.getPropertyValue("--muted").trim(),
      stroke: CSS.getPropertyValue("--stroke").trim(),
      text: CSS.getPropertyValue("--text").trim(),
    };

    /* =================================
       Time
    ================================== */
    function pad(n){ return String(n).padStart(2,"0"); }
    function tickClock(){
      const d = new Date();
      clockEl.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    tickClock();
    setInterval(tickClock, 250);

    /* =================================
       Map projection & canvas render
    ================================== */
    const canvas = document.getElementById("mapCanvas");
    const ctx = canvas.getContext("2d");

    function fitCanvasToCSS(){
      // Match internal resolution to CSS pixels for crisp render
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      canvas.width  = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    // Focused projection on Europe, Nordic, MENA region
    // Bounds: lat 0° to 75°, lng -20° to 65°
    const MAP_BOUNDS = { minLat: -5, maxLat: 75, minLng: -25, maxLng: 70 };

    function project(lat, lng, w, h){
      const x = (lng - MAP_BOUNDS.minLng) / (MAP_BOUNDS.maxLng - MAP_BOUNDS.minLng) * w;
      const y = (MAP_BOUNDS.maxLat - lat) / (MAP_BOUNDS.maxLat - MAP_BOUNDS.minLat) * h;
      return {x, y};
    }

    // Draw simplified world map contours
    function drawWorldBase(w,h){
      ctx.clearRect(0,0,w,h);

      // subtle grid
      ctx.save();
      ctx.globalAlpha = 0.20;
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.lineWidth = 1;
      const stepX = Math.max(90, w/8);
      const stepY = Math.max(70, h/6);
      for(let x=0; x<=w; x+=stepX){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let y=0; y<=h; y+=stepY){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.restore();

      // Detailed continent contours for Europe, Nordic, MENA focus (lng, lat)
      const continents = {
        // Iberian Peninsula (Spain & Portugal)
        iberia: [
          [-9.5, 37], [-9, 38.7], [-8.5, 41.8], [-9, 42], [-8, 43.5], [-4, 43.5],
          [-2, 43.3], [0, 42.7], [3.2, 42.4], [3.3, 41.5], [0.5, 40.5], [0, 39],
          [-0.5, 38], [-1.5, 37.5], [-5, 36.2], [-5.5, 36], [-7.5, 37], [-9.5, 37]
        ],
        // France
        france: [
          [-4, 48.5], [-1.5, 48.6], [2, 51], [2.5, 51], [4, 50], [4.2, 49.5],
          [8, 49], [7.5, 47.5], [7, 47], [6.5, 46.3], [6, 46.2], [7, 44],
          [6.5, 43.5], [3.5, 43.2], [3, 42.5], [0, 42.7], [-2, 43.3], [-4, 43.5],
          [-4.5, 48], [-4, 48.5]
        ],
        // British Isles - Great Britain
        britain: [
          [-5.5, 50], [-5, 50.5], [-4, 50.3], [-3, 50.7], [-1, 50.8], [1.3, 51.1],
          [1.7, 52], [1.2, 52.8], [0.5, 53], [0, 53.5], [-0.5, 54], [-1.5, 54.5],
          [-3, 54.6], [-3.5, 55], [-4.5, 55.5], [-5, 55.8], [-5.5, 57.5], [-5, 58.5],
          [-3, 58.6], [-2, 57.7], [-1.5, 57], [-2, 56.5], [-3.5, 56], [-4.5, 55],
          [-5, 54.5], [-4.5, 54], [-3.5, 53.5], [-3, 53], [-3, 52], [-5, 51.5],
          [-5.5, 50]
        ],
        // Ireland
        ireland: [
          [-10, 51.5], [-10.5, 52], [-10.3, 53.5], [-9.5, 54], [-8.5, 55], [-7.5, 55.3],
          [-6, 55], [-6, 54], [-6.5, 53.5], [-6, 52.5], [-6.5, 52], [-8, 51.5],
          [-9.5, 51.5], [-10, 51.5]
        ],
        // Germany, BeNeLux, Central Europe
        centralEurope: [
          [6, 54.5], [7, 53.5], [9, 54], [10, 54.5], [11, 54], [14, 54], [14.5, 53],
          [14.5, 51], [15, 51], [15, 50], [12.5, 49], [13, 48.5], [12.5, 47.5],
          [10, 47], [9, 47.5], [7.5, 47.5], [8, 49], [6, 49.5], [5, 50], [4, 51],
          [4, 52], [5, 53], [6, 54.5]
        ],
        // Scandinavia - Norway
        norway: [
          [5, 58], [6, 58.5], [5.5, 59], [6, 60], [5, 61], [5.5, 62], [7, 62.5],
          [8, 63], [9, 63.5], [10, 64], [12, 65], [14, 66], [15, 67], [16, 68],
          [18, 69], [20, 70], [23, 70.5], [25, 71], [28, 71], [30, 70], [28, 69.5],
          [26, 69], [24, 68.5], [20, 68], [18, 67], [17, 66], [16, 64], [14, 63],
          [12, 62], [10, 61], [9, 60], [8, 59], [6.5, 58], [5, 58]
        ],
        // Sweden & Finland
        swedenFinland: [
          [11, 56], [12, 56], [14, 56], [16, 56.5], [18, 57], [19, 58], [18, 59],
          [18, 60], [20, 60], [21, 61], [22, 62], [24, 63], [25, 64], [26, 65],
          [27, 66], [28, 68], [29, 69], [30, 70], [28, 71], [25, 71], [24, 70],
          [22, 69], [20, 68.5], [18, 68], [16, 66], [14, 64], [13, 62], [12, 60],
          [12, 58], [11, 56]
        ],
        // Italy
        italy: [
          [7.5, 44], [8, 44], [8.5, 45.5], [11, 46.5], [13.5, 46.5], [13.5, 45.5],
          [12.5, 45], [12.5, 44], [14, 42.5], [15.5, 42], [16, 41.5], [17, 41],
          [18, 40.5], [18.5, 40], [17, 39], [16, 38.5], [15.5, 38], [16, 37.5],
          [15, 36.5], [12.5, 37.5], [13, 38.5], [12.5, 39], [11, 40], [10, 42],
          [9, 42], [8.5, 42.5], [9, 44], [7.5, 44]
        ],
        // Sicily
        sicily: [
          [12, 38], [13, 38.2], [15, 38], [15.5, 37.5], [15, 36.7], [12.5, 37],
          [12, 38]
        ],
        // Balkans (Greece, Albania, Serbia, etc)
        balkans: [
          [14, 46], [16, 46], [19, 46], [21, 44], [23, 44], [23, 42], [26, 42],
          [26, 41], [24, 40], [24, 38], [23, 37], [22, 36.5], [20, 36.5], [20, 38],
          [19, 39], [20, 40], [19, 41.5], [19, 42], [17, 43], [16, 44], [14, 45],
          [14, 46]
        ],
        // Turkey
        turkey: [
          [26, 41], [28, 41.5], [29, 41], [32, 42], [34, 42], [36, 41.5], [38, 40],
          [40, 40], [42, 39], [44, 40], [44, 38], [42, 37], [36, 36.5], [35, 36],
          [32, 36.5], [30, 36.5], [28, 36.5], [27, 37], [26, 38], [26, 41]
        ],
        // North Africa - Morocco to Egypt
        northAfrica: [
          [-17, 21], [-17, 28], [-13, 29], [-10, 30], [-8, 31.5], [-6, 33], [-5, 34],
          [-5, 35.5], [-2, 35.5], [0, 35], [3, 37], [8, 37], [10, 37], [11, 33],
          [10, 32], [12, 32], [15, 32], [20, 32], [25, 32], [25, 31.5], [32, 31.5],
          [35, 31], [35, 29], [32, 24], [30, 22], [25, 22], [20, 20], [15, 21],
          [10, 20], [5, 18], [0, 15], [-5, 15], [-10, 17], [-15, 19], [-17, 21]
        ],
        // Arabian Peninsula & Middle East
        middleEast: [
          [35, 31], [35, 33], [36, 34], [36, 35.5], [37, 36], [40, 37], [42, 37],
          [45, 37], [48, 36], [50, 37], [52, 35], [54, 31], [56, 27], [56, 25],
          [56, 22], [55, 18], [53, 16], [52, 15], [50, 15], [45, 13], [43, 13],
          [43, 17], [42, 18], [40, 20], [39, 22], [38, 24], [35, 28], [35, 31]
        ],
        // Iceland
        iceland: [
          [-24, 64], [-22, 65.5], [-18, 66.5], [-14, 66], [-13.5, 65], [-14, 64.5],
          [-17, 63.5], [-21, 63.5], [-24, 64]
        ],
        // Svalbard
        svalbard: [
          [10, 77], [15, 78], [20, 79.5], [25, 80], [28, 79], [25, 77.5], [18, 76.5],
          [10, 77]
        ],
        // Eastern Europe (Poland, Ukraine, Belarus)
        eastEurope: [
          [14, 54], [18, 55], [22, 55], [24, 54], [24, 52], [28, 52], [32, 52],
          [36, 50], [40, 48], [40, 46], [35, 46], [30, 46], [28, 48], [24, 49],
          [22, 49], [20, 50], [18, 50], [15, 51], [14, 52], [14, 54]
        ],
        // Russia (western part visible)
        russiaWest: [
          [28, 71], [32, 70], [40, 68], [44, 68], [50, 67], [55, 68], [60, 70],
          [68, 72], [68, 68], [60, 62], [55, 58], [50, 56], [45, 55], [40, 52],
          [35, 50], [32, 52], [28, 52], [24, 54], [22, 55], [24, 58], [26, 60],
          [28, 62], [30, 65], [30, 68], [28, 71]
        ]
      };

      // Draw continents
      ctx.save();
      ctx.fillStyle = "rgba(0,217,255,0.05)";
      ctx.strokeStyle = "rgba(0,217,255,0.18)";
      ctx.lineWidth = 1.2;

      function drawContinent(points) {
        if(points.length < 2) return;
        ctx.beginPath();
        const start = project(points[0][1], points[0][0], w, h);
        ctx.moveTo(start.x, start.y);
        for(let i = 1; i < points.length; i++) {
          const p = project(points[i][1], points[i][0], w, h);
          ctx.lineTo(p.x, p.y);
        }
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
      }

      Object.values(continents).forEach(drawContinent);
      ctx.restore();

      // frame vignette
      ctx.save();
      const grd = ctx.createRadialGradient(w*0.50,h*0.50,Math.min(w,h)*0.10, w*0.50,h*0.50, Math.max(w,h)*0.80);
      grd.addColorStop(0,"rgba(0,0,0,0)");
      grd.addColorStop(1,"rgba(0,0,0,0.35)");
      ctx.fillStyle = grd;
      ctx.fillRect(0,0,w,h);
      ctx.restore();
    }

    // Station visuals and moving particles
    const stationState = new Map(); // id -> {phase, pulse, status}
    const particles = []; // {sx,sy,tx,ty, t, speed, color, width, alpha}

    function initStationState(){
      stations.forEach((s, i) => {
        stationState.set(s.id, {
          phase: Math.random()*Math.PI*2,
          pulse: 0,
          // allow one station to become anomaly later
          status: s.status
        });
      });
    }

    function spawnParticle(sx,sy, tx,ty, color){
      particles.push({
        sx,sy, tx,ty,
        t: 0,
        speed: 0.006 + Math.random()*0.008, // Slower particle speed
        color,
        width: 1 + Math.random()*1.2,
        alpha: 0.45 + Math.random()*0.35
      });
      if(particles.length > 300) particles.splice(0, particles.length-300);
    }

    function drawStationsAndParticles(w,h, timeSec){
      // AION ingress point in GERMANY (lat: 51, lng: 10)
      // Using equirectangular projection: x = (lng+180)/360*w, y = (90-lat)/180*h
      const target = project(51, 10, w, h);

      // particles move toward target
      for(let i=particles.length-1; i>=0; i--){
        const p = particles[i];
        p.t += p.speed;
        if(p.t >= 1){
          particles.splice(i,1);
          continue;
        }
        const x = p.sx + (p.tx - p.sx)*p.t;
        const y = p.sy + (p.ty - p.sy)*p.t;
        const fade = Math.sin(Math.PI * p.t);
        ctx.save();
        ctx.globalAlpha = p.alpha * fade;
        ctx.strokeStyle = p.color;
        ctx.lineWidth = p.width;
        ctx.beginPath();
        ctx.moveTo(x, y);
        // short tail
        const tailT = Math.max(0, p.t - 0.06);
        const tx2 = p.sx + (p.tx - p.sx)*tailT;
        const ty2 = p.sy + (p.ty - p.sy)*tailT;
        ctx.lineTo(tx2, ty2);
        ctx.stroke();
        ctx.restore();

        // small head dot
        ctx.save();
        ctx.globalAlpha = p.alpha * fade;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(x,y, 1.9, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
      }

      // stations
      stations.forEach((s) => {
        const st = stationState.get(s.id);
        const {x,y} = project(s.lat, s.lng, w, h);

        // pulsing
        const pulse = 0.55 + 0.45*Math.sin(timeSec*2.1 + st.phase);
        const r = 2.2 + 2.8*pulse;
        const glowR = r + 10*pulse;

        const status = st.status;
        const color =
          status === "warning" ? C.warn :
          status === "anomaly" ? C.err :
          status === "offline" ? "rgba(140,140,160,0.85)" :
          C.accent;

        // halo
        ctx.save();
        ctx.globalAlpha = 0.10 + 0.18*pulse;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x,y, glowR, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        // core dot
        ctx.save();
        ctx.globalAlpha = 0.90;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x,y, r, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        // occasional particle to center (reduced frequency)
        if(visibilityPhase >= 2 && Math.random() < 0.025){
          spawnParticle(x,y, target.x, target.y, (status==="warning"||status==="anomaly") ? C.warn : C.accent2);
        }

        // draw tiny label only for warning/anomaly (to keep clean)
        if(status === "warning" || status === "anomaly"){
          ctx.save();
          ctx.font = "11px " + CSS.getPropertyValue("--mono").trim();
          ctx.fillStyle = "rgba(255,255,255,0.80)";
          ctx.shadowColor = "rgba(0,0,0,0.65)";
          ctx.shadowBlur = 8;
          ctx.fillText(s.id, x+8, y-8);
          ctx.restore();
        }
      });

      // ingress glow
      ctx.save();
      ctx.globalAlpha = 0.30;
      ctx.strokeStyle = "rgba(0,217,255,0.25)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(target.x, target.y, 34, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();

      ctx.save();
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = "rgba(0,217,255,0.20)";
      ctx.beginPath();
      ctx.arc(target.x, target.y, 18 + 4*Math.sin(timeSec*2.0), 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    /* =================================
       Telemetry generation
    ================================== */
    function rand(min,max){ return min + Math.random()*(max-min); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function fmt(n){ return n.toLocaleString("en-US"); }

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function sigmaForValue(param, value){
      // approximate sigma based on corridor width (2σ ~ half-range if symmetric)
      const [a,b] = param.normalRange;
      const mu = (a+b)/2;
      const sigma = Math.max(1e-6, (b-a)/4); // because μ±2σ spans (b-a)
      return (value - mu) / sigma;
    }

    function genValue(param){
      const [a,b] = param.normalRange;
      const mu = (a+b)/2;
      const sigma = (b-a)/4;

      // mostly nominal; sometimes warning; rarely anomaly
      const r = Math.random();
      let val;
      if(r < 0.86){
        val = mu + rand(-1.2, 1.2)*sigma;
      } else if(r < 0.97){
        val = mu + rand(2.05, 2.6)*sigma * (Math.random()<0.6 ? 1 : -1);
      } else {
        val = mu + rand(3.0, 3.6)*sigma * (Math.random()<0.6 ? 1 : -1);
      }
      // clamp to sane boundaries
      if(param.name === "solar") val = clamp(val, 0, 4300);
      if(param.name === "humidity") val = clamp(val, 0, 100);
      if(param.name === "tilt_angle") val = clamp(val, 0, 90);
      if(param.name === "wind") val = clamp(val, 0, 120);

      return val;
    }

    function formatValue(param, value){
      if(param.unit === "Hz" || param.unit === "W") return `${Math.round(value)} ${param.unit}`;
      if(param.unit === "mV" || param.unit === "A") return `${value.toFixed(1)} ${param.unit}`;
      if(param.unit === "g") return `${value.toFixed(2)} ${param.unit}`;
      if(param.unit === "°C") return `${value.toFixed(1)}${param.unit}`;
      if(param.unit === "%") return `${Math.round(value)}${param.unit}`;
      if(param.unit === "km/h") return `${Math.round(value)} ${param.unit}`;
      if(param.unit === "°") return `${Math.round(value)}${param.unit}`;
      return `${value.toFixed(2)} ${param.unit}`;
    }

    function stationBadge(status){
      if(status==="anomaly") return { cls:"bErr", label:"ANOM" };
      if(status==="warning") return { cls:"bWarn", label:"WARN" };
      if(status==="offline") return { cls:"bErr", label:"OFF" };
      return { cls:"bNom", label:"NOM" };
    }

    function createTelemetryItem(station, forcedHighlight=null){
      // pick 3 params
      const params = [
        pick(telemetryParams),
        pick(telemetryParams),
        pick(telemetryParams),
      ];

      // ensure unique
      const uniq = [];
      for(const p of params){
        if(!uniq.find(x=>x.name===p.name)) uniq.push(p);
      }
      while(uniq.length < 3){
        const p = pick(telemetryParams);
        if(!uniq.find(x=>x.name===p.name)) uniq.push(p);
      }

      // values
      const rows = uniq.map(p => {
        let v = genValue(p);
        // if forced highlight, push this parameter out
        if(forcedHighlight && forcedHighlight.name === p.name){
          const [a,b] = p.normalRange;
          const mu = (a+b)/2;
          const sigma = (b-a)/4;
          v = mu + forcedHighlight.sigma * sigma;
        }
        const s = sigmaForValue(p, v);
        return { p, v, sigma: s };
      });

      // determine status
      let maxAbsSigma = Math.max(...rows.map(r => Math.abs(r.sigma)));
      let status = stationState.get(station.id).status;
      let overall = "nominal";
      if(maxAbsSigma >= 3) overall = "anomaly";
      else if(maxAbsSigma >= 2) overall = "warning";

      // convert for display badge (if station itself is warning/anomaly/offline, keep it)
      if(status === "offline") overall = "offline";
      else if(status === "anomaly") overall = "anomaly";
      else if(status === "warning") overall = (overall==="anomaly" ? "anomaly" : "warning");

      const badge = stationBadge(overall);

      // build DOM
      const el = document.createElement("div");
      el.className = "tItem";

      const top = document.createElement("div");
      top.className = "tTop";
      top.innerHTML = `
        <div>
          <span>${station.id}</span>
          <span class="loc">${station.location}</span>
        </div>
        <div class="badge">
          <span class="bDot ${badge.cls}"></span>
          <span>${badge.label}</span>
        </div>
      `;
      el.appendChild(top);

      rows.forEach(r => {
        const line = document.createElement("div");
        line.className = "tLine";
        const ok = Math.abs(r.sigma) < 2;
        const mark = ok ? `<span class="okMark">✓</span>` : `<span class="warnMark">⚠</span>`;
        const sig = ok ? "" : `<span class="sigma">(${(r.sigma>0?"+":"")}${r.sigma.toFixed(1)}σ)</span>`;
        line.innerHTML = `
          <div class="k">${r.p.name}</div>
          <div>${formatValue(r.p, r.v)} ${mark} ${sig}</div>
        `;
        el.appendChild(line);
      });

      return { el, overall, rows };
    }

    /* =================================
       Engine stats simulation
    ================================== */
    let train = 0;
    let online = 47;
    let dph = 2847291;
    let patterns = 12847;
    let anomToday = 3;
    let lastUpdateMin = 2;
    let dataTodayM = 68.3;
    let predictionsActive = 12;

    function setEngineUI(){
      trainFill.style.width = `${train}%`;
      trainPct.textContent = Math.round(train);

      onlineEl.textContent = online;
      dphEl.textContent = fmt(dph);
      patternsEl.textContent = fmt(patterns);
      anomTodayEl.textContent = anomToday;
      lastUpdateEl.textContent = `${lastUpdateMin} min ago`;

      fOnline.textContent = online;
      dataToday.textContent = `${dataTodayM.toFixed(1)}M`;
      predActive.textContent = predictionsActive;
      mtbf.textContent = `+${Math.round(320 + (patterns/2000))}%`;
    }

    function tickEngine(){
      // training slowly cycles
      train += 0.9 + Math.random()*0.9;
      if(train >= 100){
        train = 12 + Math.random()*8;
        lastUpdateMin = 0;
      } else {
        lastUpdateMin = Math.min(9, lastUpdateMin + (Math.random()<0.35 ? 1 : 0));
      }

      // stats drift
      dph += Math.floor( 18000 + Math.random()*52000 );
      patterns += Math.floor( 6 + Math.random()*22 );
      dataTodayM += 0.08 + Math.random()*0.10;

      // online can fluctuate slightly
      if(Math.random() < 0.18){
        online = Math.max(44, Math.min(50, online + (Math.random()<0.6 ? 1 : -1)));
      }

      // anomalies today nudges slowly
      if(Math.random() < 0.10){
        anomToday = Math.max(0, Math.min(12, anomToday + (Math.random()<0.55 ? 1 : -1)));
      }

      // predictions active: tied to patterns
      predictionsActive = Math.max(8, Math.min(22, Math.round(10 + patterns/1500)));

      setEngineUI();
    }

    /* =================================
       Anomaly orchestration & timing
    ================================== */
    // visibilityPhase:
    // 0-2s: map appear, stations light up sequentially
    // 2-4s: particles start flying to ingress
    // 4-6s: engine panel appears
    // 6-8s: telemetry starts
    // 8-10s: anomaly appears (station turns yellow/red)
    // 10-12s: popup appears
    // 12s: loop-ish
    let visibilityPhase = 0;

    const ANOMALY_STATION_ID = "iONE-046"; // North Sea Platform
    const ANOMALY_PARAM = { name: "bearing_freq", sigma: +2.1 }; // (+2.1σ)
    const ANOMALY_VALUE_TEXT = "891 Hz";
    const ANOMALY_BASELINE_TEXT = "843 ± 12 Hz";
    const ANOMALY_DEV_TEXT = "+2.1σ";

    function showAnomalyPopup(){
      // set popup fields
      popupTs.textContent = new Date().toLocaleTimeString();
      pStation.textContent = `${ANOMALY_STATION_ID} North Sea`;
      pParam.textContent = "bearing_freq";
      pValue.textContent = ANOMALY_VALUE_TEXT;
      pBase.textContent = ANOMALY_BASELINE_TEXT;
      pDev.textContent = ANOMALY_DEV_TEXT;

      pPred.textContent = "PREDICTION: Bearing replacement recommended";
      pRec.textContent = "Recommended within 7 days · iONEOS threshold updated fleet-wide";

      drawMiniChart();

      popup.classList.add("on");
      // Keep popup visible longer for better UX
      setTimeout(()=> popup.classList.remove("on"), 8000);
    }

    function drawMiniChart(){
      const w = chartCanvas.width, h = chartCanvas.height;
      chartCtx.clearRect(0,0,w,h);

      // background
      chartCtx.fillStyle = "rgba(10,10,22,0.0)";
      chartCtx.fillRect(0,0,w,h);

      // axis lines
      chartCtx.strokeStyle = "rgba(255,255,255,0.10)";
      chartCtx.lineWidth = 1;
      chartCtx.beginPath();
      chartCtx.moveTo(10, h-20);
      chartCtx.lineTo(w-10, h-20);
      chartCtx.stroke();

      // corridor (μ ± 2σ) block
      const x0 = 70;
      const x1 = w - 40;
      const yMid = h/2;
      const bandH = 42;
      const top = yMid - bandH/2;
      const bottom = yMid + bandH/2;

      chartCtx.fillStyle = "rgba(0,217,255,0.10)";
      chartCtx.fillRect(x0, top, x1-x0, bandH);
      chartCtx.strokeStyle = "rgba(0,217,255,0.18)";
      chartCtx.strokeRect(x0, top, x1-x0, bandH);

      // baseline line
      chartCtx.strokeStyle = "rgba(255,255,255,0.12)";
      chartCtx.beginPath();
      chartCtx.moveTo(x0, yMid);
      chartCtx.lineTo(x1, yMid);
      chartCtx.stroke();

      // current point above corridor to the top-right
      const px = x0 + (x1-x0)*0.78;
      const py = top - 10;

      chartCtx.fillStyle = "rgba(255,184,0,0.95)";
      chartCtx.shadowColor = "rgba(255,184,0,0.35)";
      chartCtx.shadowBlur = 16;
      chartCtx.beginPath();
      chartCtx.arc(px, py, 5.5, 0, Math.PI*2);
      chartCtx.fill();
      chartCtx.shadowBlur = 0;

      // label
      chartCtx.fillStyle = "rgba(255,255,255,0.78)";
      chartCtx.font = "11px " + CSS.getPropertyValue("--mono").trim();
      chartCtx.fillText("baseline", x0, h-6);
      chartCtx.fillText("+2σ", x1-26, top-4);
      chartCtx.fillStyle = "rgba(255,184,0,0.95)";
      chartCtx.fillText("current", px+10, py+4);
    }

    /* =================================
       Map animation loop
    ================================== */
    let t0 = performance.now();
    function frame(now){
      const t = (now - t0)/1000;
      const rect = canvas.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      // render
      drawWorldBase(w,h);
      drawStationsAndParticles(w,h, t);

      requestAnimationFrame(frame);
    }

    /* =================================
       Reveal sequencing (0..12s loop)
    ================================== */
    function startSequence(){
      // 0-2s: map appear, stations ignite
      mapCard.classList.add("on");
      mapHint.textContent = "booting map layer…";
      setTimeout(() => {
        mapGlow.classList.add("on");
        mapHint.textContent = "fleet nodes online · syncing…";
      }, 600);

      setTimeout(() => {
        ingress.classList.add("on");
      }, 1100);

      // 2-4s: particles
      setTimeout(() => {
        visibilityPhase = 2;
        mapHint.textContent = "telemetry uplink → AION";
      }, 2000);

      // 4-6s: engine panel
      setTimeout(() => {
        visibilityPhase = 4;
        panelEngine.classList.add("on");
        mapHint.textContent = "AION training started";
      }, 4000);

      // 5s: telemetry panel
      setTimeout(() => {
        visibilityPhase = 5;
        panelTelemetry.classList.add("on");
        mapHint.textContent = "live stream running";
      }, 5000);

      // 6s: anomaly panel appears, station becomes warning
      setTimeout(() => {
        visibilityPhase = 6;
        panelAnomaly.classList.add("on");
        const st = stationState.get(ANOMALY_STATION_ID);
        if(st) st.status = "warning";
        mapHint.textContent = "⚠ μ ± 2σ corridor breach detected";
      }, 6000);

      // 7s: popup shows and station turns anomaly - THE KEY MOMENT
      setTimeout(() => {
        visibilityPhase = 7;
        const st = stationState.get(ANOMALY_STATION_ID);
        if(st) st.status = "anomaly";
        showAnomalyPopup();
        mapHint.textContent = "🔴 ANOMALY DETECTED → prediction generated";
      }, 7000);

      // 15s: reset to warning for loop
      setTimeout(() => {
        visibilityPhase = 15;
        const st = stationState.get(ANOMALY_STATION_ID);
        if(st) st.status = "warning";
        mapHint.textContent = "monitoring continues…";
      }, 15000);
    }

    function loopSequence(){
      // every 20s, replay anomaly event
      setInterval(() => {
        mapHint.textContent = "monitoring fleet telemetry…";
        const st = stationState.get(ANOMALY_STATION_ID);
        if(st) st.status = "warning";

        setTimeout(() => {
          mapHint.textContent = "⚠ deviation detected...";
        }, 1500);

        setTimeout(() => {
          if(st) st.status = "anomaly";
          showAnomalyPopup();
          anomToday = Math.min(12, anomToday + 1);
          setEngineUI();
          mapHint.textContent = "🔴 ANOMALY → generating prediction";
        }, 3000);

        setTimeout(() => {
          if(st) st.status = "warning";
          mapHint.textContent = "prediction delivered · monitoring continues";
        }, 12000);

      }, 20000);
    }

    /* =================================
       Telemetry feed loop (6s+)
    ================================== */
    function startTelemetryLoop(){
      const keep = 6; // number of cards visible
      function pushTelemetry(forced=false){
        // choose a station (biased to show interesting ones)
        let s;
        if(forced){
          s = stations.find(x=>x.id===ANOMALY_STATION_ID) || stations[0];
        } else {
          // bias: sometimes pick warning/anomaly station
          if(Math.random() < 0.22){
            s = stations.find(x=>x.id===ANOMALY_STATION_ID) || stations[0];
          } else {
            s = stations[Math.floor(Math.random()*stations.length)];
          }
        }

        const forcedHighlight = forced ? ANOMALY_PARAM : null;
        const item = createTelemetryItem(s, forcedHighlight);

        // if anomaly station and forced highlight -> show σ and warning
        if(forced){
          // make station warning on map
          const st = stationState.get(ANOMALY_STATION_ID);
          if(st) st.status = "warning";
        }

        telemetryList.prepend(item.el);

        // trim
        while(telemetryList.children.length > keep){
          telemetryList.lastElementChild.remove();
        }
      }

      // warm-up burst when telemetry panel appears
      setTimeout(() => { pushTelemetry(false); pushTelemetry(false); }, 6100);

      // normal cadence (slowed down)
      setInterval(() => {
        if(visibilityPhase < 6) return;
        // occasionally inject the exact example line
        const inject = (Math.random() < 0.20);
        if(inject && visibilityPhase >= 8){
          pushTelemetry(true);
        } else {
          pushTelemetry(false);
        }
      }, 2500);
    }

    /* =================================
       Engine stats loop (4s+)
    ================================== */
    function startEngineLoop(){
      setEngineUI();
      setInterval(() => {
        if(visibilityPhase < 4) return;
        tickEngine();
      }, 2500);
    }

    /* =================================
       Boot
    ================================== */
    initStationState();

    // Resize handling
    function onResize(){
      fitCanvasToCSS();
    }
    window.addEventListener("resize", onResize, {passive:true});
    setTimeout(onResize, 0);

    // Start render
    requestAnimationFrame(frame);

    // Start scripted sequence + loops
    startSequence();
    loopSequence();
    startEngineLoop();
    startTelemetryLoop();

    // make panels persist after first reveal
    setTimeout(() => {
      panelEngine.classList.add("on");
      panelTelemetry.classList.add("on");
      panelAnomaly.classList.add("on");
    }, 13000);

  })();
  </script>
</body>
</html>
